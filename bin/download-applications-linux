#!/bin/bash
set -euo pipefail

# Define the list of URLs and checksums to download
downloads=(
  "https://storage.googleapis.com/skaffold/releases/v2.17.0/skaffold-linux-amd64 skaffold 12d16e5c18b0232cbe0854d3e8b1581a98e58c1a415b060d4b5da70e43a17708"
  "https://dl.k8s.io/release/v1.35.0/bin/linux/amd64/kubectl kubectl a2e984a18a0c063279d692533031c1eff93a262afcc0afdc517375432d060989"
  "https://github.com/kubernetes/minikube/releases/download/v1.38.0/minikube-linux-amd64 minikube 6f3fa62bbc3820dbe1f1cffe4beef62c466a8fb1058837781d20d36233dcfa12"
  "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.7.1/kustomize_v5.7.1_linux_amd64.tar.gz kustomize 54636edecead2af90fa980cdc6a66a5ce062a1e4d694a2e36357cd73190755bb"
  "https://github.com/rhysd/actionlint/releases/download/v1.7.10/actionlint_1.7.10_linux_amd64.tar.gz actionlint 98def53d7668f0f87cb2dd57addd825399ab1bc1902286944d662aa56c4e2cbe"
  "https://github.com/stern/stern/releases/download/v1.33.1/stern_1.33.1_linux_amd64.tar.gz stern 147b6b8bc89f8a6980267e3ff66023877a5a7ad2a158d6328bf94a94cd3c0c3f"
  "https://github.com/ahmetb/kubectx/releases/download/v0.9.5/kubens_v0.9.5_linux_x86_64.tar.gz kubens 8ffbe8a7109d199dd3c199b6c2f58ddf77146f6f822b5c5d437010bbe9fd4144"
  "https://github.com/ahmetb/kubectx/releases/download/v0.9.5/kubectx_v0.9.5_linux_x86_64.tar.gz kubectx 0bbb4d4fbd8807ec20b86a9e880a68eedc20f27655826ad8f65982de47f6d74b"
)

# Define the directory to download the binaries to
download_dir="$HOME/bin/secret-project"

# Create the download directory if it doesn't exist
mkdir -p "$download_dir"

# Download each binary from the list of URLs
for download in "${downloads[@]}"; do
  # Extract the URL and checksum from the download string
  url=$(echo "$download" | awk '{print $1}')
  filename=$(echo "$download" | awk '{print $2}')
  checksum=$(echo "$download" | awk '{print $3}')
  destination="$download_dir/$filename"
  # If file already downloaded and checksum matches, skip
  if [ -f "$destination" ] && echo "$checksum  $download_dir/$filename" | sha256sum --check --status; then
    echo "$filename already exists in $download_dir"
    continue
  fi

  echo "Downloading $filename from $url to $destination"

  # If the url is a tar.gz, download it to a temporary file and extract it to a temporary directory
  # We will verify the binary inside the tar.gz
  if [[ "$url" == *.tar.gz ]]; then
    tmpfile=$(mktemp)
    tmpdir=$(mktemp -d)
    curl -Lss "$url" -o "$tmpfile"
    tar -xzf "$tmpfile" -C "$tmpdir"
    # Find the binary in the temporary directory using $filename as a pattern
    binary=$(find "$tmpdir" -name "$filename")
    # Move the binary to the download directory
    mv "$binary" "$destination"
    # Remove the temporary file and directory
    rm "$tmpfile"
    rm -rf "$tmpdir"

  else
    # Download the binary to the download directory
    curl -Lss "$url" -o "$destination"
  fi

  # Verify the checksum of the downloaded file
  if ! echo "$checksum  $destination" | sha256sum --check --status; then
    echo "Checksum verification failed for $filename"
    # Expected and was
    echo "Expected the checksum to be $checksum  but was $(sha256sum "$destination")"
    # Remove the file if the checksum doesn't match
    rm "$destination"
    exit 1
  fi


done
echo "Downloaded all binaries successfully"
chmod +x "$download_dir"/*
ls -l "$download_dir"

# Add the download directory to the PATH
# Detect shell
shell_profile="$HOME/.profile"

# Detect whether the PATH has already been added
if grep -q "$download_dir" "$shell_profile"; then
  echo "$download_dir already exists in $shell_profile"
  exit 0
fi
echo "export PATH=$download_dir:\$PATH" >> "$shell_profile"
echo "Added $download_dir to $shell_profile"
echo "export PATH=$HOME/.cargo/bin:\$PATH" >> "$shell_profile"
echo "Added $HOME/.cargo/bin to PATH as requested by cargo"

cargo install sqlx-cli --no-default-features --features rustls,postgres
cargo install oxipng
