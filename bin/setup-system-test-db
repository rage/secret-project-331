#!/bin/bash
# Only meant to be ran against the database in minikube when running system tests with bin/test.
set -euo pipefail

BASEDIR="$(dirname "${BASH_SOURCE[0]}")"
FOLDER_PATH="$BASEDIR/../services/headless-lms/"
RELATIVE_PATH=$(realpath --relative-to="$(pwd)" "$FOLDER_PATH")
POD_NAME=$(kubectl get pods -l app=headless-lms -o name | head -n 1)

COMMAND="kubectl"
ARGUMENTS=(exec -it "$POD_NAME" -- wait-for-it --timeout=120 postgres:5432)

echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
"$COMMAND" "${ARGUMENTS[@]}"

echo "> cd $RELATIVE_PATH"
cd "$RELATIVE_PATH" || exit

COMMAND="kubectl"
ARGUMENTS=(exec -it "$POD_NAME" -- env PGPASSWORD=only-for-local-development-intentionally-public dropdb --host=postgres --port=5432 --username=headless-lms --no-password --if-exists --force headless_lms_test)

echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
"$COMMAND" "${ARGUMENTS[@]}"

COMMAND="kubectl"
ARGUMENTS=(exec -it "$POD_NAME" -- cargo sqlx --database-url postgres://headless-lms:only-for-local-development-intentionally-public@postgres:5432/headless_lms_test database setup)

echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
"$COMMAND" "${ARGUMENTS[@]}"

# FILE_PATH="db/seed"
# RELATIVE_PATH=$(realpath --relative-to="$(pwd)" "$FILE_PATH")

# COMMAND="kubectl"
# ARGUMENTS=(cp "$RELATIVE_PATH" "postgres-0:/seed")

# echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
# "$COMMAND" "${ARGUMENTS[@]}"

# COMMAND="kubectl"
# ARGUMENTS=(exec -it "$POD_NAME" -- env PGPASSWORD=only-for-local-development-intentionally-public pg_restore  --host=postgres --port=5432 --username=headless-lms --no-password --disable-triggers --dbname=headless_lms_test "db/seed")

COMMAND="kubectl"
ARGUMENTS=(exec -it "$POD_NAME" "$@" -- env PGPASSWORD=only-for-local-development-intentionally-public  cargo run --bin seed "$@")


echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
exec "$COMMAND" "${ARGUMENTS[@]}"
