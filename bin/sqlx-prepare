#!/bin/bash
# Only meant to be ran against the database in minikube. You can start it with
# either `bin/dev` or `bin/dev-only-db`.
set -euo pipefail

BASEDIR="$(dirname "${BASH_SOURCE[0]}")"
FOLDER_PATH="$BASEDIR/../services/headless-lms/"
RELATIVE_PATH=$(realpath --relative-to="$(pwd)" "$FOLDER_PATH")

echo "> cd $RELATIVE_PATH"
cd "$RELATIVE_PATH" || exit

COMMAND="cargo"
ARGUMENTS=(sqlx --database-url postgres://headless-lms@localhost:54328/headless_lms_dev prepare "$@")

echo "> $COMMAND" "$(printf "%q " "${ARGUMENTS[@]}")"
eval "$COMMAND" "${ARGUMENTS[@]}"

# Formatting the result file so that diffs are pretty
COMMAND2="npx"
ARGUMENTS2=(prettier --write sqlx-data.json)

echo "> $COMMAND2" "$(printf "%q " "${ARGUMENTS2[@]}")"
eval "$COMMAND2" "${ARGUMENTS2[@]}"
