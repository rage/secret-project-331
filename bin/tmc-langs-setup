#!/bin/bash
set -euo pipefail
source "$(dirname "$0")/.common"

BASEDIR="$(dirname "${BASH_SOURCE[0]}")"
FOLDER_PATH="$BASEDIR/../services/tmc/"
RELATIVE_PATH=$(realpath --relative-to="$(pwd)" "$FOLDER_PATH")
run_command cd "$RELATIVE_PATH" || exit

VERSION=$(head -n1 ./src/tmc/cli.d.ts | cut -d= -f2)

# Detect system architecture
ARCH=""
case "$OSTYPE" in
    "linux-gnu"*)
        case "$(uname -m)" in
            "x86_64")
                ARCH="x86_64-unknown-linux-gnu"
                ;;
            "i686")
                ARCH="i686-unknown-linux-gnu"
                ;;
            "aarch64")
                ARCH="aarch64-unknown-linux-gnu"
                ;;
            "armv7l")
                ARCH="armv7-unknown-linux-gnueabihf"
                ;;
            *)
                echo "Unsupported Linux architecture: $(uname -m)"
                exit 1
                ;;
        esac
        ;;
    "darwin"*)
        case "$(uname -m)" in
            "x86_64")
                ARCH="x86_64-apple-darwin"
                ;;
            "arm64")
                ARCH="aarch64-apple-darwin"
                ;;
            *)
                echo "Unsupported macOS architecture: $(uname -m)"
                exit 1
                ;;
        esac
        ;;
    "msys"*|"cygwin"*)
        # For Windows, we can use the PROCESSOR_ARCHITECTURE environment variable
        case "$PROCESSOR_ARCHITECTURE" in
            "AMD64")
                ARCH="x86_64-pc-windows-msvc"
                ;;
            "x86")
                ARCH="i686-pc-windows-msvc"
                ;;
            *)
                echo "Unsupported Windows architecture: $PROCESSOR_ARCHITECTURE"
                exit 1
                ;;
        esac
        ;;
    *)
        echo "Unsupported OS type: $OSTYPE"
        exit 1
        ;;
esac

if [ -z "$ARCH" ]; then
    echo "Could not determine architecture"
    exit 1
fi

# Set file extension based on OS
EXT=""
case "$OSTYPE" in
    "msys"*|"cygwin"*)
        EXT=".exe"
        ;;
esac

LANGS_FILENAME="tmc-langs-cli-$ARCH-$VERSION$EXT"
LANGS_PATH="./bin/$LANGS_FILENAME"
CHECKSUM_FILENAME="$LANGS_FILENAME.sha256"
CHECKSUM_PATH="./bin/$CHECKSUM_FILENAME"

echo "Setup TMC langs version: $VERSION for architecture: $ARCH"

run_command mkdir -p ./bin

verify_checksum() {
    local file=$1
    local checksum_file=$2
    local expected_hash
    local actual_hash
    local temp_output

    # Validate input files exist
    if [ ! -f "$file" ]; then
        echo "Error: File to verify does not exist: $file" >&2
        return 1
    fi

    if [ ! -f "$checksum_file" ]; then
        echo "Error: Checksum file does not exist: $checksum_file" >&2
        return 1
    fi

    case "$OSTYPE" in
        "msys"*|"cygwin"*)
            # Windows: Use PowerShell's Get-FileHash
            # Check if PowerShell is available
            if ! command -v powershell >/dev/null 2>&1; then
                echo "Error: PowerShell not found in PATH" >&2
                return 1
            fi

            # Escape file paths for PowerShell by converting to absolute paths and using single quotes
            local abs_file
            local abs_checksum_file
            abs_file=$(realpath "$file" 2>/dev/null) || {
                echo "Error: Cannot resolve absolute path for file: $file" >&2
                return 1
            }
            abs_checksum_file=$(realpath "$checksum_file" 2>/dev/null) || {
                echo "Error: Cannot resolve absolute path for checksum file: $checksum_file" >&2
                return 1
            }

            # Extract expected hash
            temp_output=$(powershell -Command "try { Get-Content -LiteralPath '$abs_checksum_file' -ErrorAction Stop | ForEach-Object { (\$_.Split(' ', [System.StringSplitOptions]::RemoveEmptyEntries))[0].Trim() } | Select-Object -First 1 } catch { Write-Error \$_.Exception.Message; exit 1 }" 2>&1) || {
                echo "Error: Failed to read checksum from $checksum_file: $temp_output" >&2
                return 1
            }
            expected_hash="$temp_output"

            # Calculate actual hash
            temp_output=$(powershell -Command "try { (Get-FileHash -LiteralPath '$abs_file' -Algorithm SHA256 -ErrorAction Stop).Hash.ToLower() } catch { Write-Error \$_.Exception.Message; exit 1 }" 2>&1) || {
                echo "Error: Failed to calculate hash for $file: $temp_output" >&2
                return 1
            }
            actual_hash="$temp_output"
            ;;
        *)
            # Linux/macOS: Use sha256sum
            # Check if required commands are available
            if ! command -v sha256sum >/dev/null 2>&1; then
                echo "Error: sha256sum not found in PATH" >&2
                return 1
            fi

            if ! command -v cut >/dev/null 2>&1; then
                echo "Error: cut not found in PATH" >&2
                return 1
            fi

            # Extract expected hash
            temp_output=$(cat "$checksum_file" 2>&1) || {
                echo "Error: Failed to read checksum file: $checksum_file" >&2
                return 1
            }
            expected_hash=$(echo "$temp_output" | head -n1 | cut -d' ' -f1 | tr -d '[:space:]')

            if [ -z "$expected_hash" ]; then
                echo "Error: Could not extract hash from checksum file: $checksum_file" >&2
                return 1
            fi

            # Calculate actual hash
            temp_output=$(sha256sum "$file" 2>&1) || {
                echo "Error: Failed to calculate hash for file: $file" >&2
                return 1
            }
            actual_hash=$(echo "$temp_output" | cut -d' ' -f1 | tr -d '[:space:]')
            ;;
    esac

    # Compare hashes
    if [ "$expected_hash" = "$actual_hash" ]; then
        return 0
    else
        echo "Error: Checksum verification failed" >&2
        echo "Expected: $expected_hash" >&2
        echo "Actual:   $actual_hash" >&2
        return 1
    fi
}

# Check if file exists and verify checksum
if [ -f "$LANGS_PATH" ] && [ -f "$CHECKSUM_PATH" ]; then
    echo "Found existing CLI binary, verifying checksum..."
    if verify_checksum "$LANGS_PATH" "$CHECKSUM_PATH"; then
        echo "Checksum matched, skipping download"
        run_command chmod +x "$LANGS_PATH"
        exit 0
    else
        echo "Checksum verification failed, will download again"
    fi
fi

echo "Removing old CLI versions if any"
run_command find ./bin -maxdepth 1 -type f -name 'tmc-langs-cli-*' -delete

echo "Downloading CLI to $LANGS_PATH"
run_command curl "https://download.mooc.fi/tmc-langs-rust/${LANGS_FILENAME}" --output "$LANGS_PATH"

echo "Downloading checksum"
run_command curl "https://download.mooc.fi/tmc-langs-rust/${CHECKSUM_FILENAME}" --output "$CHECKSUM_PATH"

echo "Verifying checksum"
if ! verify_checksum "$LANGS_PATH" "$CHECKSUM_PATH"; then
    echo "Checksum verification failed"
    exit 1
fi

run_command chmod +x "$LANGS_PATH"
