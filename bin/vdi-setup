#!/bin/bash
set -euo pipefail
banner="########### MOOC-VDI setup ###########"

# Check if /data exists
if [ ! -d /data ]; then
  echo "ERROR: /data doesn't exist. Are you sure this is a VDI and are you sure it has been configured properly?"
  exit 1
fi

echo "/data exists"

original_user="$(logname)"
original_home="/home/$original_user"


# Run as root
if [ "$EUID" -ne 0 ]; then
  echo "ERROR: Please run as root"
  exit 1
fi

echo "Running as root"

# Create folder /data/$original_user
if [ ! -d "/data/$original_user" ]; then
  mkdir "/data/$original_user"
fi

echo "/data/$original_user exists"

# Create /data/$original_user/.profile
if [ ! -f "/data/$original_user/.profile" ]; then
  touch "/data/$original_user/.profile"
fi

echo "/data/$original_user/.profile exists"

# Create /data/$original_user/Code/secret-project-331
if [ ! -d "/data/$original_user/Code/secret-project-331" ]; then
  mkdir -p "/data/$original_user/Code/secret-project-331"
fi

echo "/data/$original_user/Code/secret-project-331 exists"

bashrc_addition=$(cat <<-END

$banner
if [ "\$(hostname)" = "$(hostname)"  ] ; then
    echo "Switching home dir to a local disk for performance."
    export HOME=/data/\$original_user
    source /data/$original_user/.profile
    cd "\$HOME/Code/secret-project-331"
    export SHELL=/usr/bin/fish
    [ -x \$SHELL ] && exec \$SHELL "\$@"
fi
$banner

END
)

echo "bashrc_addition is $bashrc_addition"

script_to_run_as_original_user=$(cat <<-END
#!/bin/bash
set -euo pipefail
echo "Running as $original_user"
# If .bashrc doesn't exist, create it
if [ ! -f "$original_home/.bashrc" ]; then
  touch "$original_home/.bashrc"
fi

# check if banner in .bashrc
if grep -q "$banner" "$original_home/.bashrc"; then
  echo "Vdi snippet alredy exists in $original_home/.bashrc"
else
    echo "Vdi snippet found in $original_home/.bashrc"
    echo "Adding banner to $original_home/.bashrc"
    echo "$bashrc_addition" >> "$original_home/.bashrc"
fi

# If the bashrc_addition is not in the .bashrc, add it
if ! grep -q "$bashrc_addition" "$original_home/.bashrc"; then
  echo "$bashrc_addition" >> "$original_home/.bashrc"
else
    echo "bashrc_addition already exists in $original_home/.bashrc"
fi
END
)

echo "Running script"
echo "$script_to_run_as_original_user"

sudo -u "$original_user" bash -c "$script_to_run_as_original_user"
