CREATE TABLE chatbot_conversation_suggested_messages (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  deleted_at TIMESTAMP WITH TIME ZONE,
  message VARCHAR(32376) NOT NULL,
  conversation_message_id UUID NOT NULL REFERENCES chatbot_conversation_messages(id)
);

CREATE TRIGGER set_timestamp BEFORE
UPDATE ON chatbot_conversation_suggested_messages FOR EACH ROW EXECUTE PROCEDURE trigger_set_timestamp();

CREATE INDEX ON chatbot_conversation_suggested_messages(conversation_message_id)
WHERE deleted_at IS NULL;

COMMENT ON TABLE chatbot_conversation_suggested_messages IS 'Messages that the user is suggested to send to the chatbot next. New messages are generated after every chatbot message';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.id IS 'A unique, stable identifier for the record.';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.created_at IS 'Timestamp when the record was created.';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.updated_at IS 'Timestamp when the record was last updated. The field is updated automatically by the set_timestamp trigger.';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.deleted_at IS 'Timestamp when the record was deleted. If null, the record is not deleted.';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.message IS 'The message that is suggested.';
COMMENT ON COLUMN chatbot_conversation_suggested_messages.conversation_message_id IS 'The chatbot conversation message after which this suggested message was generated. This is how we know which suggested messages to display at the current point in time.';

ALTER TABLE chatbot_configurations
ADD suggest_next_messages BOOLEAN NOT NULL DEFAULT FALSE,
  ADD initial_suggested_messages VARCHAR(32376) [];

COMMENT ON COLUMN chatbot_configurations.suggest_next_messages IS 'If true, the user is given suggested next messages generated by an LLM based on the conversation so far.';
COMMENT ON COLUMN chatbot_configurations.initial_suggested_messages IS 'Message suggestions to be displayed at the beginning of the conversation that the teacher configures. Unlimited, if more than three, 3 are chosen at random.';
