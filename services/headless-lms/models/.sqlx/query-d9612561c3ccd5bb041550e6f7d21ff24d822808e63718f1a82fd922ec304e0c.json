{
  "db_name": "PostgreSQL",
  "query": "\nWITH deduped_completions AS (\n  SELECT *\n  FROM (\n      SELECT cmc.*,\n        CASE\n          WHEN cmr.course_module_completion_id IS NOT NULL THEN 1\n          ELSE 0\n        END AS is_registered,\n        ROW_NUMBER() OVER (\n          PARTITION BY cmc.user_id,\n          cmc.course_module_id\n          ORDER BY CASE\n              WHEN cmr.course_module_completion_id IS NOT NULL THEN 1\n              ELSE 0\n            END DESC,\n            cmc.created_at DESC\n        ) AS rn\n      FROM course_module_completions cmc\n        LEFT JOIN course_module_completion_registered_to_study_registries cmr ON cmc.id = cmr.course_module_completion_id\n        AND cmr.deleted_at IS NULL\n      WHERE cmc.deleted_at IS NULL\n        AND (\n          $1::int IS NULL\n          OR EXTRACT(\n            YEAR\n            FROM cmc.completion_date\n          ) = $1\n        )\n    ) sub\n  WHERE rn = 1\n),\nunique_registrations AS (\n  SELECT DISTINCT course_module_completion_id\n  FROM course_module_completion_registered_to_study_registries cmr\n  WHERE cmr.deleted_at IS NULL\n)\nSELECT u.email_domain AS \"email_domain!\",\n  COUNT(DISTINCT d.id) AS \"total_completions!\",\n  COUNT(DISTINCT d.user_id) AS \"unique_users!\",\n  ROUND(\n    (\n      SUM(\n        CASE\n          WHEN ur.course_module_completion_id IS NOT NULL THEN 1\n          ELSE 0\n        END\n      ) * 100.0\n    ) / NULLIF(COUNT(DISTINCT d.id), 0),\n    2\n  )::float8 AS \"registered_completion_percentage\",\n  SUM(\n    CASE\n      WHEN ur.course_module_completion_id IS NOT NULL THEN 1\n      ELSE 0\n    END\n  ) AS \"registered_completions!\",\n  SUM(\n    CASE\n      WHEN ur.course_module_completion_id IS NULL THEN 1\n      ELSE 0\n    END\n  ) AS \"not_registered_completions!\",\n  COUNT(\n    DISTINCT CASE\n      WHEN ur.course_module_completion_id IS NOT NULL THEN d.user_id\n    END\n  ) AS \"users_with_some_registered_completions!\",\n  COUNT(\n    DISTINCT CASE\n      WHEN ur.course_module_completion_id IS NULL THEN d.user_id\n    END\n  ) AS \"users_with_some_unregistered_completions!\",\n  COALESCE(\n    SUM(\n      CASE\n        WHEN ur.course_module_completion_id IS NOT NULL THEN cm.ects_credits\n        ELSE 0\n      END\n    ),\n    0\n  ) AS \"registered_ects_credits!\",\n  COALESCE(\n    SUM(\n      CASE\n        WHEN ur.course_module_completion_id IS NULL THEN cm.ects_credits\n        ELSE 0\n      END\n    ),\n    0\n  ) AS \"not_registered_ects_credits!\"\nFROM deduped_completions d\n  JOIN users u ON d.user_id = u.id\n  AND u.deleted_at IS NULL\n  LEFT JOIN unique_registrations ur ON d.id = ur.course_module_completion_id\n  JOIN courses c ON d.course_id = c.id\n  AND c.deleted_at IS NULL\n  JOIN course_modules cm ON d.course_module_id = cm.id\n  AND cm.deleted_at IS NULL\nWHERE d.prerequisite_modules_completed = TRUE\n  AND c.is_draft = FALSE\n  AND c.is_test_mode = FALSE\n  AND cm.enable_registering_completion_to_uh_open_university = TRUE\n  AND cm.ects_credits IS NOT NULL\n  AND cm.ects_credits > 0\nGROUP BY u.email_domain\nORDER BY \"total_completions!\" DESC,\n  email_domain\n        ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "email_domain!",
        "type_info": "Varchar"
      },
      {
        "ordinal": 1,
        "name": "total_completions!",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "unique_users!",
        "type_info": "Int8"
      },
      {
        "ordinal": 3,
        "name": "registered_completion_percentage",
        "type_info": "Float8"
      },
      {
        "ordinal": 4,
        "name": "registered_completions!",
        "type_info": "Int8"
      },
      {
        "ordinal": 5,
        "name": "not_registered_completions!",
        "type_info": "Int8"
      },
      {
        "ordinal": 6,
        "name": "users_with_some_registered_completions!",
        "type_info": "Int8"
      },
      {
        "ordinal": 7,
        "name": "users_with_some_unregistered_completions!",
        "type_info": "Int8"
      },
      {
        "ordinal": 8,
        "name": "registered_ects_credits!",
        "type_info": "Float4"
      },
      {
        "ordinal": 9,
        "name": "not_registered_ects_credits!",
        "type_info": "Float4"
      }
    ],
    "parameters": {
      "Left": ["Int4"]
    },
    "nullable": [true, null, null, null, null, null, null, null, null, null]
  },
  "hash": "d9612561c3ccd5bb041550e6f7d21ff24d822808e63718f1a82fd922ec304e0c"
}
