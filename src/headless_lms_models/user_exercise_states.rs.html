<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `models/src/user_exercise_states.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>user_exercise_states.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"></nav><main><div class="width-limiter"><nav class="sub"><a class="sub-logo-container" href="../../headless_lms_models/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><pre class="src-line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
<span id="576">576</span>
<span id="577">577</span>
<span id="578">578</span>
<span id="579">579</span>
<span id="580">580</span>
<span id="581">581</span>
<span id="582">582</span>
<span id="583">583</span>
<span id="584">584</span>
<span id="585">585</span>
<span id="586">586</span>
<span id="587">587</span>
<span id="588">588</span>
<span id="589">589</span>
<span id="590">590</span>
<span id="591">591</span>
<span id="592">592</span>
<span id="593">593</span>
<span id="594">594</span>
<span id="595">595</span>
<span id="596">596</span>
<span id="597">597</span>
<span id="598">598</span>
<span id="599">599</span>
<span id="600">600</span>
<span id="601">601</span>
<span id="602">602</span>
<span id="603">603</span>
<span id="604">604</span>
<span id="605">605</span>
<span id="606">606</span>
<span id="607">607</span>
<span id="608">608</span>
<span id="609">609</span>
<span id="610">610</span>
<span id="611">611</span>
<span id="612">612</span>
<span id="613">613</span>
<span id="614">614</span>
<span id="615">615</span>
<span id="616">616</span>
<span id="617">617</span>
<span id="618">618</span>
<span id="619">619</span>
<span id="620">620</span>
<span id="621">621</span>
<span id="622">622</span>
<span id="623">623</span>
<span id="624">624</span>
<span id="625">625</span>
<span id="626">626</span>
<span id="627">627</span>
<span id="628">628</span>
<span id="629">629</span>
<span id="630">630</span>
<span id="631">631</span>
<span id="632">632</span>
<span id="633">633</span>
<span id="634">634</span>
<span id="635">635</span>
<span id="636">636</span>
<span id="637">637</span>
<span id="638">638</span>
<span id="639">639</span>
<span id="640">640</span>
<span id="641">641</span>
<span id="642">642</span>
<span id="643">643</span>
<span id="644">644</span>
<span id="645">645</span>
<span id="646">646</span>
<span id="647">647</span>
<span id="648">648</span>
<span id="649">649</span>
<span id="650">650</span>
<span id="651">651</span>
<span id="652">652</span>
<span id="653">653</span>
<span id="654">654</span>
<span id="655">655</span>
<span id="656">656</span>
<span id="657">657</span>
<span id="658">658</span>
<span id="659">659</span>
<span id="660">660</span>
<span id="661">661</span>
<span id="662">662</span>
<span id="663">663</span>
<span id="664">664</span>
<span id="665">665</span>
<span id="666">666</span>
<span id="667">667</span>
<span id="668">668</span>
<span id="669">669</span>
<span id="670">670</span>
<span id="671">671</span>
<span id="672">672</span>
<span id="673">673</span>
<span id="674">674</span>
<span id="675">675</span>
<span id="676">676</span>
<span id="677">677</span>
<span id="678">678</span>
<span id="679">679</span>
<span id="680">680</span>
<span id="681">681</span>
<span id="682">682</span>
<span id="683">683</span>
<span id="684">684</span>
<span id="685">685</span>
<span id="686">686</span>
<span id="687">687</span>
<span id="688">688</span>
<span id="689">689</span>
<span id="690">690</span>
<span id="691">691</span>
<span id="692">692</span>
<span id="693">693</span>
<span id="694">694</span>
<span id="695">695</span>
<span id="696">696</span>
<span id="697">697</span>
<span id="698">698</span>
<span id="699">699</span>
<span id="700">700</span>
<span id="701">701</span>
<span id="702">702</span>
<span id="703">703</span>
<span id="704">704</span>
<span id="705">705</span>
<span id="706">706</span>
<span id="707">707</span>
<span id="708">708</span>
<span id="709">709</span>
<span id="710">710</span>
<span id="711">711</span>
<span id="712">712</span>
<span id="713">713</span>
<span id="714">714</span>
<span id="715">715</span>
<span id="716">716</span>
<span id="717">717</span>
<span id="718">718</span>
<span id="719">719</span>
<span id="720">720</span>
<span id="721">721</span>
<span id="722">722</span>
<span id="723">723</span>
<span id="724">724</span>
<span id="725">725</span>
<span id="726">726</span>
<span id="727">727</span>
<span id="728">728</span>
<span id="729">729</span>
<span id="730">730</span>
<span id="731">731</span>
<span id="732">732</span>
<span id="733">733</span>
<span id="734">734</span>
<span id="735">735</span>
<span id="736">736</span>
<span id="737">737</span>
<span id="738">738</span>
<span id="739">739</span>
<span id="740">740</span>
<span id="741">741</span>
<span id="742">742</span>
<span id="743">743</span>
<span id="744">744</span>
<span id="745">745</span>
<span id="746">746</span>
<span id="747">747</span>
<span id="748">748</span>
<span id="749">749</span>
<span id="750">750</span>
<span id="751">751</span>
<span id="752">752</span>
<span id="753">753</span>
<span id="754">754</span>
<span id="755">755</span>
<span id="756">756</span>
<span id="757">757</span>
<span id="758">758</span>
<span id="759">759</span>
<span id="760">760</span>
<span id="761">761</span>
<span id="762">762</span>
<span id="763">763</span>
<span id="764">764</span>
<span id="765">765</span>
<span id="766">766</span>
<span id="767">767</span>
<span id="768">768</span>
<span id="769">769</span>
<span id="770">770</span>
<span id="771">771</span>
<span id="772">772</span>
<span id="773">773</span>
<span id="774">774</span>
<span id="775">775</span>
<span id="776">776</span>
<span id="777">777</span>
<span id="778">778</span>
<span id="779">779</span>
<span id="780">780</span>
<span id="781">781</span>
<span id="782">782</span>
<span id="783">783</span>
<span id="784">784</span>
<span id="785">785</span>
<span id="786">786</span>
<span id="787">787</span>
<span id="788">788</span>
<span id="789">789</span>
<span id="790">790</span>
<span id="791">791</span>
<span id="792">792</span>
<span id="793">793</span>
<span id="794">794</span>
<span id="795">795</span>
<span id="796">796</span>
<span id="797">797</span>
<span id="798">798</span>
<span id="799">799</span>
<span id="800">800</span>
<span id="801">801</span>
<span id="802">802</span>
<span id="803">803</span>
<span id="804">804</span>
<span id="805">805</span>
<span id="806">806</span>
<span id="807">807</span>
<span id="808">808</span>
<span id="809">809</span>
<span id="810">810</span>
<span id="811">811</span>
<span id="812">812</span>
<span id="813">813</span>
<span id="814">814</span>
<span id="815">815</span>
<span id="816">816</span>
<span id="817">817</span>
<span id="818">818</span>
<span id="819">819</span>
<span id="820">820</span>
<span id="821">821</span>
<span id="822">822</span>
<span id="823">823</span>
<span id="824">824</span>
<span id="825">825</span>
<span id="826">826</span>
<span id="827">827</span>
<span id="828">828</span>
<span id="829">829</span>
<span id="830">830</span>
<span id="831">831</span>
<span id="832">832</span>
<span id="833">833</span>
<span id="834">834</span>
<span id="835">835</span>
<span id="836">836</span>
<span id="837">837</span>
<span id="838">838</span>
<span id="839">839</span>
<span id="840">840</span>
<span id="841">841</span>
<span id="842">842</span>
<span id="843">843</span>
<span id="844">844</span>
<span id="845">845</span>
<span id="846">846</span>
<span id="847">847</span>
<span id="848">848</span>
<span id="849">849</span>
<span id="850">850</span>
<span id="851">851</span>
<span id="852">852</span>
<span id="853">853</span>
<span id="854">854</span>
<span id="855">855</span>
<span id="856">856</span>
<span id="857">857</span>
<span id="858">858</span>
<span id="859">859</span>
<span id="860">860</span>
<span id="861">861</span>
<span id="862">862</span>
<span id="863">863</span>
<span id="864">864</span>
<span id="865">865</span>
<span id="866">866</span>
<span id="867">867</span>
<span id="868">868</span>
<span id="869">869</span>
<span id="870">870</span>
<span id="871">871</span>
<span id="872">872</span>
<span id="873">873</span>
<span id="874">874</span>
<span id="875">875</span>
<span id="876">876</span>
<span id="877">877</span>
<span id="878">878</span>
<span id="879">879</span>
<span id="880">880</span>
<span id="881">881</span>
<span id="882">882</span>
<span id="883">883</span>
<span id="884">884</span>
<span id="885">885</span>
<span id="886">886</span>
<span id="887">887</span>
<span id="888">888</span>
<span id="889">889</span>
<span id="890">890</span>
<span id="891">891</span>
<span id="892">892</span>
<span id="893">893</span>
<span id="894">894</span>
<span id="895">895</span>
<span id="896">896</span>
<span id="897">897</span>
<span id="898">898</span>
<span id="899">899</span>
<span id="900">900</span>
<span id="901">901</span>
<span id="902">902</span>
<span id="903">903</span>
<span id="904">904</span>
<span id="905">905</span>
<span id="906">906</span>
<span id="907">907</span>
<span id="908">908</span>
<span id="909">909</span>
<span id="910">910</span>
<span id="911">911</span>
<span id="912">912</span>
<span id="913">913</span>
<span id="914">914</span>
<span id="915">915</span>
<span id="916">916</span>
<span id="917">917</span>
<span id="918">918</span>
<span id="919">919</span>
<span id="920">920</span>
<span id="921">921</span>
<span id="922">922</span>
<span id="923">923</span>
<span id="924">924</span>
<span id="925">925</span>
<span id="926">926</span>
<span id="927">927</span>
<span id="928">928</span>
<span id="929">929</span>
<span id="930">930</span>
<span id="931">931</span>
<span id="932">932</span>
<span id="933">933</span>
<span id="934">934</span>
<span id="935">935</span>
<span id="936">936</span>
<span id="937">937</span>
<span id="938">938</span>
<span id="939">939</span>
<span id="940">940</span>
<span id="941">941</span>
<span id="942">942</span>
<span id="943">943</span>
<span id="944">944</span>
<span id="945">945</span>
<span id="946">946</span>
<span id="947">947</span>
<span id="948">948</span>
<span id="949">949</span>
<span id="950">950</span>
<span id="951">951</span>
<span id="952">952</span>
<span id="953">953</span>
<span id="954">954</span>
<span id="955">955</span>
<span id="956">956</span>
<span id="957">957</span>
<span id="958">958</span>
<span id="959">959</span>
<span id="960">960</span>
<span id="961">961</span>
<span id="962">962</span>
<span id="963">963</span>
<span id="964">964</span>
<span id="965">965</span>
<span id="966">966</span>
<span id="967">967</span>
<span id="968">968</span>
<span id="969">969</span>
<span id="970">970</span>
<span id="971">971</span>
<span id="972">972</span>
<span id="973">973</span>
<span id="974">974</span>
<span id="975">975</span>
<span id="976">976</span>
<span id="977">977</span>
<span id="978">978</span>
<span id="979">979</span>
<span id="980">980</span>
<span id="981">981</span>
<span id="982">982</span>
<span id="983">983</span>
<span id="984">984</span>
<span id="985">985</span>
<span id="986">986</span>
<span id="987">987</span>
<span id="988">988</span>
<span id="989">989</span>
<span id="990">990</span>
<span id="991">991</span>
<span id="992">992</span>
<span id="993">993</span>
<span id="994">994</span>
<span id="995">995</span>
<span id="996">996</span>
<span id="997">997</span>
<span id="998">998</span>
<span id="999">999</span>
<span id="1000">1000</span>
<span id="1001">1001</span>
<span id="1002">1002</span>
<span id="1003">1003</span>
<span id="1004">1004</span>
<span id="1005">1005</span>
<span id="1006">1006</span>
<span id="1007">1007</span>
<span id="1008">1008</span>
<span id="1009">1009</span>
<span id="1010">1010</span>
<span id="1011">1011</span>
<span id="1012">1012</span>
<span id="1013">1013</span>
<span id="1014">1014</span>
<span id="1015">1015</span>
<span id="1016">1016</span>
<span id="1017">1017</span>
<span id="1018">1018</span>
<span id="1019">1019</span>
<span id="1020">1020</span>
<span id="1021">1021</span>
<span id="1022">1022</span>
<span id="1023">1023</span>
<span id="1024">1024</span>
<span id="1025">1025</span>
<span id="1026">1026</span>
<span id="1027">1027</span>
<span id="1028">1028</span>
<span id="1029">1029</span>
<span id="1030">1030</span>
<span id="1031">1031</span>
<span id="1032">1032</span>
<span id="1033">1033</span>
<span id="1034">1034</span>
<span id="1035">1035</span>
<span id="1036">1036</span>
<span id="1037">1037</span>
<span id="1038">1038</span>
<span id="1039">1039</span>
<span id="1040">1040</span>
<span id="1041">1041</span>
<span id="1042">1042</span>
<span id="1043">1043</span>
<span id="1044">1044</span>
<span id="1045">1045</span>
<span id="1046">1046</span>
<span id="1047">1047</span>
<span id="1048">1048</span>
<span id="1049">1049</span>
<span id="1050">1050</span>
<span id="1051">1051</span>
<span id="1052">1052</span>
<span id="1053">1053</span>
<span id="1054">1054</span>
<span id="1055">1055</span>
<span id="1056">1056</span>
<span id="1057">1057</span>
<span id="1058">1058</span>
<span id="1059">1059</span>
<span id="1060">1060</span>
<span id="1061">1061</span>
<span id="1062">1062</span>
<span id="1063">1063</span>
<span id="1064">1064</span>
<span id="1065">1065</span>
<span id="1066">1066</span>
<span id="1067">1067</span>
<span id="1068">1068</span>
<span id="1069">1069</span>
<span id="1070">1070</span>
<span id="1071">1071</span>
<span id="1072">1072</span>
<span id="1073">1073</span>
<span id="1074">1074</span>
<span id="1075">1075</span>
<span id="1076">1076</span>
<span id="1077">1077</span>
<span id="1078">1078</span>
<span id="1079">1079</span>
<span id="1080">1080</span>
<span id="1081">1081</span>
<span id="1082">1082</span>
<span id="1083">1083</span>
<span id="1084">1084</span>
<span id="1085">1085</span>
<span id="1086">1086</span>
<span id="1087">1087</span>
<span id="1088">1088</span>
<span id="1089">1089</span>
<span id="1090">1090</span>
<span id="1091">1091</span>
<span id="1092">1092</span>
<span id="1093">1093</span>
<span id="1094">1094</span>
<span id="1095">1095</span>
<span id="1096">1096</span>
<span id="1097">1097</span>
<span id="1098">1098</span>
<span id="1099">1099</span>
<span id="1100">1100</span>
<span id="1101">1101</span>
<span id="1102">1102</span>
<span id="1103">1103</span>
<span id="1104">1104</span>
<span id="1105">1105</span>
<span id="1106">1106</span>
<span id="1107">1107</span>
<span id="1108">1108</span>
<span id="1109">1109</span>
<span id="1110">1110</span>
<span id="1111">1111</span>
<span id="1112">1112</span>
<span id="1113">1113</span>
<span id="1114">1114</span>
<span id="1115">1115</span>
<span id="1116">1116</span>
<span id="1117">1117</span>
<span id="1118">1118</span>
<span id="1119">1119</span>
<span id="1120">1120</span>
<span id="1121">1121</span>
<span id="1122">1122</span>
<span id="1123">1123</span>
<span id="1124">1124</span>
<span id="1125">1125</span>
<span id="1126">1126</span>
<span id="1127">1127</span>
<span id="1128">1128</span>
<span id="1129">1129</span>
<span id="1130">1130</span>
<span id="1131">1131</span>
<span id="1132">1132</span>
<span id="1133">1133</span>
<span id="1134">1134</span>
<span id="1135">1135</span>
<span id="1136">1136</span>
<span id="1137">1137</span>
<span id="1138">1138</span>
<span id="1139">1139</span>
<span id="1140">1140</span>
<span id="1141">1141</span>
<span id="1142">1142</span>
<span id="1143">1143</span>
<span id="1144">1144</span>
<span id="1145">1145</span>
<span id="1146">1146</span>
<span id="1147">1147</span>
<span id="1148">1148</span>
<span id="1149">1149</span>
<span id="1150">1150</span>
<span id="1151">1151</span>
<span id="1152">1152</span>
<span id="1153">1153</span>
<span id="1154">1154</span>
<span id="1155">1155</span>
</pre><pre class="rust"><code><span class="kw">use </span>std::collections::HashMap;

<span class="kw">use </span>futures::Stream;
<span class="kw">use </span>headless_lms_utils::numbers::option_f32_to_f32_two_decimals_with_none_as_zero;
<span class="kw">use </span>serde_json::Value;

<span class="kw">use crate</span>::{
    course_instances,
    course_modules::{<span class="self">self</span>, CourseModule},
    courses,
    exercises::{ActivityProgress, Exercise, GradingProgress},
    prelude::<span class="kw-2">*</span>,
    user_course_settings,
};

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Eq, Clone, Copy, Type)]
#[sqlx(type_name = <span class="string">&quot;reviewing_stage&quot;</span>, rename_all = <span class="string">&quot;snake_case&quot;</span>)]
#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, derive(TS))]
</span><span class="doccomment">/**
Tells what stage of reviewing the user is currently in. Used for for peer review, self review, and manual review. If an exercise does not involve reviewing, the value of this stage will always be `NotStarted`.
*/
</span><span class="kw">pub enum </span>ReviewingStage {
    <span class="doccomment">/**
    In this stage the user submits answers to the exercise. If the exercise allows it, the user can answer the exercise multiple times. If the exercise is not in this stage, the user cannot answer the exercise. Most exercises will never leave this stage because other stages are reseverved for situations when we cannot give the user points just based on the automatic gradings.
    */
    </span>NotStarted,
    <span class="doccomment">/// In this stage the student is instructed to give peer reviews to other students.
    </span>PeerReview,
    <span class="doccomment">/// In this stage the student is instructed to review their own answer.
    </span>SelfReview,
    <span class="doccomment">/// In this stage the student has completed the neccessary peer and self reviews but is waiting for other students to peer review their answer before we can give points for this exercise.
    </span>WaitingForPeerReviews,
    <span class="doccomment">/**
    In this stage the student has completed everything they need to do, but before we can give points for this exercise, we need a manual grading from the teacher.

    Reasons for ending up in this stage may be one of these:

    1. The exercise is configured to require all answers to be reviewed by the teacher.
    2. The answer has received poor reviews from the peers, and the exercise has been configured so that the teacher has to double-check whether it is justified to not give full points to the student.
    */
    </span>WaitingForManualGrading,
    <span class="doccomment">/**
    In this stage the the reviews have been completed and the points have been awarded to the student. However, since the answer had to go though the review process, the student may no longer answer the exercise since because

    1. It is likely that we revealed the model solution to the student during the review process.
    2. In case of peer review, a new answer would have to be reviewed by other students again, and that would be unreasonable extra work for others.

    If the teacher for some reasoon feels bad for the student and wants to give them a new chance, the answers for this exercise should be reset, the reason should be recorded somewhere in the database, and the value of this column should be set to `NotStarted`. Deleting the whole user_exercise_state may also be wise. However, if we end up doing this for a teacher, we should make sure that the teacher realizes that they should not give an unfair advantage to anyone.
    */
    </span>ReviewedAndLocked,
}

<span class="attribute">#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, derive(TS))]
#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>UserExerciseState {
    <span class="kw">pub </span>id: Uuid,
    <span class="kw">pub </span>user_id: Uuid,
    <span class="kw">pub </span>exercise_id: Uuid,
    <span class="kw">pub </span>course_instance_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    <span class="kw">pub </span>exam_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    <span class="kw">pub </span>created_at: DateTime&lt;Utc&gt;,
    <span class="kw">pub </span>updated_at: DateTime&lt;Utc&gt;,
    <span class="kw">pub </span>deleted_at: <span class="prelude-ty">Option</span>&lt;DateTime&lt;Utc&gt;&gt;,
    <span class="kw">pub </span>score_given: <span class="prelude-ty">Option</span>&lt;f32&gt;,
    <span class="kw">pub </span>grading_progress: GradingProgress,
    <span class="kw">pub </span>activity_progress: ActivityProgress,
    <span class="kw">pub </span>reviewing_stage: ReviewingStage,
    <span class="kw">pub </span>selected_exercise_slide_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
}

<span class="kw">impl </span>UserExerciseState {
    <span class="kw">pub fn </span>get_course_instance_id(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; ModelResult&lt;Uuid&gt; {
        <span class="self">self</span>.course_instance_id.ok_or_else(|| {
            ModelError::new(
                ModelErrorType::Generic,
                <span class="string">&quot;Exercise is not part of a course instance.&quot;</span>.to_string(),
                <span class="prelude-val">None</span>,
            )
        })
    }

    <span class="kw">pub fn </span>get_selected_exercise_slide_id(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; ModelResult&lt;Uuid&gt; {
        <span class="self">self</span>.selected_exercise_slide_id.ok_or_else(|| {
            ModelError::new(
                ModelErrorType::Generic,
                <span class="string">&quot;No exercise slide selected.&quot;</span>.to_string(),
                <span class="prelude-val">None</span>,
            )
        })
    }
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>UserExerciseStateUpdate {
    <span class="kw">pub </span>id: Uuid,
    <span class="kw">pub </span>score_given: <span class="prelude-ty">Option</span>&lt;f32&gt;,
    <span class="kw">pub </span>activity_progress: ActivityProgress,
    <span class="kw">pub </span>reviewing_stage: ReviewingStage,
    <span class="kw">pub </span>grading_progress: GradingProgress,
}

<span class="doccomment">/// Either a course instance or exam id.
///
/// Exercises can either be part of courses or exams. Many user-related actions need to differentiate
/// between two, so `CourseInstanceOrExamId` helps when handling these separate scenarios.
</span><span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Eq, Clone, Copy)]
</span><span class="kw">pub enum </span>CourseInstanceOrExamId {
    Instance(Uuid),
    Exam(Uuid),
}

<span class="kw">impl </span>CourseInstanceOrExamId {
    <span class="kw">pub fn </span>from_instance_and_exam_ids(
        course_instance_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
        exam_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    ) -&gt; ModelResult&lt;<span class="self">Self</span>&gt; {
        <span class="kw">match </span>(course_instance_id, exam_id) {
            (<span class="prelude-val">None</span>, <span class="prelude-val">None</span>) =&gt; <span class="prelude-val">Err</span>(ModelError::new(
                ModelErrorType::Generic,
                <span class="string">&quot;Expected either course instance or exam id, but neither were provided.&quot;</span>.into(),
                <span class="prelude-val">None</span>,
            )),
            (<span class="prelude-val">Some</span>(instance_id), <span class="prelude-val">None</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="self">Self</span>::Instance(instance_id)),
            (<span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(exam_id)) =&gt; <span class="prelude-val">Ok</span>(<span class="self">Self</span>::Exam(exam_id)),
            (<span class="prelude-val">Some</span>(<span class="kw">_</span>), <span class="prelude-val">Some</span>(<span class="kw">_</span>)) =&gt; <span class="prelude-val">Err</span>(ModelError::new(
                ModelErrorType::Generic,
                <span class="string">&quot;Expected either course instance or exam id, but both were provided.&quot;</span>.into(),
                <span class="prelude-val">None</span>,
            )),
        }
    }

    <span class="kw">pub fn </span>to_instance_and_exam_ids(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; (<span class="prelude-ty">Option</span>&lt;Uuid&gt;, <span class="prelude-ty">Option</span>&lt;Uuid&gt;) {
        <span class="kw">match </span><span class="self">self </span>{
            CourseInstanceOrExamId::Instance(instance_id) =&gt; (<span class="prelude-val">Some</span>(<span class="kw-2">*</span>instance_id), <span class="prelude-val">None</span>),
            CourseInstanceOrExamId::Exam(exam_id) =&gt; (<span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(<span class="kw-2">*</span>exam_id)),
        }
    }
}

<span class="kw">impl </span>TryFrom&lt;UserExerciseState&gt; <span class="kw">for </span>CourseInstanceOrExamId {
    <span class="kw">type </span>Error = ModelError;

    <span class="kw">fn </span>try_from(user_exercise_state: UserExerciseState) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>, <span class="self">Self</span>::Error&gt; {
        <span class="self">Self</span>::from_instance_and_exam_ids(
            user_exercise_state.course_instance_id,
            user_exercise_state.exam_id,
        )
    }
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Clone)]
#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, derive(TS))]
</span><span class="kw">pub struct </span>UserCourseInstanceProgress {
    <span class="kw">pub </span>course_module_id: Uuid,
    <span class="kw">pub </span>course_module_name: String,
    <span class="kw">pub </span>course_module_order_number: i32,
    <span class="kw">pub </span>score_given: f32,
    <span class="kw">pub </span>score_required: <span class="prelude-ty">Option</span>&lt;i32&gt;,
    <span class="kw">pub </span>score_maximum: <span class="prelude-ty">Option</span>&lt;u32&gt;,
    <span class="kw">pub </span>total_exercises: <span class="prelude-ty">Option</span>&lt;u32&gt;,
    <span class="kw">pub </span>attempted_exercises: <span class="prelude-ty">Option</span>&lt;i32&gt;,
    <span class="kw">pub </span>attempted_exercises_required: <span class="prelude-ty">Option</span>&lt;i32&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Clone)]
#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, derive(TS))]
</span><span class="kw">pub struct </span>UserCourseInstanceChapterExerciseProgress {
    <span class="kw">pub </span>exercise_id: Uuid,
    <span class="kw">pub </span>score_given: f32,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Clone)]
</span><span class="kw">pub struct </span>DatabaseUserCourseInstanceChapterExerciseProgress {
    <span class="kw">pub </span>exercise_id: Uuid,
    <span class="kw">pub </span>score_given: <span class="prelude-ty">Option</span>&lt;f32&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Clone)]
</span><span class="kw">pub struct </span>UserChapterMetrics {
    <span class="kw">pub </span>score_given: <span class="prelude-ty">Option</span>&lt;f32&gt;,
    <span class="kw">pub </span>attempted_exercises: <span class="prelude-ty">Option</span>&lt;i64&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Clone)]
</span><span class="kw">pub struct </span>UserCourseInstanceMetrics {
    <span class="kw">pub </span>course_module_id: Uuid,
    <span class="kw">pub </span>score_given: <span class="prelude-ty">Option</span>&lt;f32&gt;,
    <span class="kw">pub </span>attempted_exercises: <span class="prelude-ty">Option</span>&lt;i64&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Eq, Clone)]
</span><span class="kw">pub struct </span>CourseInstanceExerciseMetrics {
    course_module_id: Uuid,
    total_exercises: <span class="prelude-ty">Option</span>&lt;i64&gt;,
    score_maximum: <span class="prelude-ty">Option</span>&lt;i64&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, FromRow, PartialEq, Eq, Clone)]
#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, derive(TS))]
</span><span class="kw">pub struct </span>ExerciseUserCounts {
    exercise_name: String,
    exercise_order_number: i32,
    page_order_number: i32,
    chapter_number: i32,
    exercise_id: Uuid,
    <span class="attribute">#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, ts(<span class="kw">type </span>= <span class="string">&quot;number&quot;</span>))]
    </span>n_users_attempted: <span class="prelude-ty">Option</span>&lt;i64&gt;,
    <span class="attribute">#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, ts(<span class="kw">type </span>= <span class="string">&quot;number&quot;</span>))]
    </span>n_users_with_some_points: <span class="prelude-ty">Option</span>&lt;i64&gt;,
    <span class="attribute">#[cfg_attr(feature = <span class="string">&quot;ts_rs&quot;</span>, ts(<span class="kw">type </span>= <span class="string">&quot;number&quot;</span>))]
    </span>n_users_with_max_points: <span class="prelude-ty">Option</span>&lt;i64&gt;,
}

<span class="kw">pub async fn </span>get_course_instance_metrics(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
) -&gt; ModelResult&lt;Vec&lt;CourseInstanceExerciseMetrics&gt;&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        CourseInstanceExerciseMetrics,
        <span class="string">r&quot;
SELECT chapters.course_module_id,
  COUNT(exercises.id) AS total_exercises,
  SUM(exercises.score_maximum) AS score_maximum
FROM course_instances
  LEFT JOIN exercises ON (course_instances.course_id = exercises.course_id)
  LEFT JOIN chapters ON (exercises.chapter_id = chapters.id)
WHERE exercises.deleted_at IS NULL
  AND course_instances.id = $1
GROUP BY chapters.course_module_id
        &quot;</span>,
        course_instance_id
    )
    .fetch_all(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_course_instance_metrics_indexed_by_module_id(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
) -&gt; ModelResult&lt;HashMap&lt;Uuid, CourseInstanceExerciseMetrics&gt;&gt; {
    <span class="kw">let </span>res = get_course_instance_metrics(conn, course_instance_id)
        .<span class="kw">await</span><span class="question-mark">?
        </span>.into_iter()
        .map(|x| (x.course_module_id, x))
        .collect();
    <span class="prelude-val">Ok</span>(res)
}

<span class="doccomment">/// Gets course instance metrics for a single module.
</span><span class="kw">pub async fn </span>get_single_module_course_instance_metrics(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    course_module_id: Uuid,
    user_id: Uuid,
) -&gt; ModelResult&lt;UserCourseInstanceMetrics&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query!</span>(
        <span class="string">&quot;
SELECT COUNT(ues.exercise_id) AS attempted_exercises,
  COALESCE(SUM(ues.score_given), 0) AS score_given
FROM user_exercise_states AS ues
  LEFT JOIN exercises ON (ues.exercise_id = exercises.id)
  LEFT JOIN chapters ON (exercises.chapter_id = chapters.id)
WHERE chapters.course_module_id = $1
  AND ues.course_instance_id = $2
  AND ues.activity_progress IN (&#39;completed&#39;, &#39;submitted&#39;)
  AND ues.user_id = $3
  AND ues.deleted_at IS NULL
        &quot;</span>,
        course_module_id,
        course_instance_id,
        user_id,
    )
    .map(|x| UserCourseInstanceMetrics {
        course_module_id,
        score_given: x.score_given,
        attempted_exercises: x.attempted_exercises,
    })
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_user_course_instance_metrics(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    user_id: Uuid,
) -&gt; ModelResult&lt;Vec&lt;UserCourseInstanceMetrics&gt;&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserCourseInstanceMetrics,
        <span class="string">r&quot;
SELECT chapters.course_module_id,
  COUNT(ues.exercise_id) AS attempted_exercises,
  COALESCE(SUM(ues.score_given), 0) AS score_given
FROM user_exercise_states AS ues
  LEFT JOIN exercises ON (ues.exercise_id = exercises.id)
  LEFT JOIN chapters ON (exercises.chapter_id = chapters.id)
WHERE ues.course_instance_id = $1
  AND ues.activity_progress IN (&#39;completed&#39;, &#39;submitted&#39;)
  AND ues.user_id = $2
  AND ues.deleted_at IS NULL
GROUP BY chapters.course_module_id;
        &quot;</span>,
        course_instance_id,
        user_id,
    )
    .fetch_all(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_user_course_instance_metrics_indexed_by_module_id(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    user_id: Uuid,
) -&gt; ModelResult&lt;HashMap&lt;Uuid, UserCourseInstanceMetrics&gt;&gt; {
    <span class="kw">let </span>res = get_user_course_instance_metrics(conn, course_instance_id, user_id)
        .<span class="kw">await</span><span class="question-mark">?
        </span>.into_iter()
        .map(|x| (x.course_module_id, x))
        .collect();
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_user_course_instance_chapter_metrics(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    exercise_ids: <span class="kw-2">&amp;</span>[Uuid],
    user_id: Uuid,
) -&gt; ModelResult&lt;UserChapterMetrics&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserChapterMetrics,
        <span class="string">r#&quot;
SELECT COUNT(ues.exercise_id) AS attempted_exercises,
  COALESCE(SUM(ues.score_given), 0) AS score_given
FROM user_exercise_states AS ues
WHERE ues.exercise_id IN (
    SELECT UNNEST($1::uuid [])
  )
  AND ues.deleted_at IS NULL
  AND ues.activity_progress IN (&#39;completed&#39;, &#39;submitted&#39;)
  AND ues.user_id = $2
  AND ues.course_instance_id = $3;
                &quot;#</span>,
        <span class="kw-2">&amp;</span>exercise_ids,
        user_id,
        course_instance_id
    )
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_user_course_instance_progress(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    user_id: Uuid,
) -&gt; ModelResult&lt;Vec&lt;UserCourseInstanceProgress&gt;&gt; {
    <span class="kw">let </span>course_metrics =
        get_course_instance_metrics_indexed_by_module_id(<span class="kw-2">&amp;mut *</span>conn, course_instance_id).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let </span>user_metrics =
        get_user_course_instance_metrics_indexed_by_module_id(conn, course_instance_id, user_id)
            .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">let </span>course_id = course_instances::get_course_instance(conn, course_instance_id)
        .<span class="kw">await</span><span class="question-mark">?
        </span>.course_id;
    <span class="kw">let </span>course_name = courses::get_course(conn, course_id).<span class="kw">await</span><span class="question-mark">?</span>.name;
    <span class="kw">let </span>course_modules = course_modules::get_by_course_id(conn, course_id).<span class="kw">await</span><span class="question-mark">?</span>;
    merge_modules_with_metrics(course_modules, <span class="kw-2">&amp;</span>course_metrics, <span class="kw-2">&amp;</span>user_metrics, <span class="kw-2">&amp;</span>course_name)
}

<span class="doccomment">/// Gets the total amount of points that the user has received from an exam.
///
/// The caller should take into consideration that for an ongoing exam the result will be volatile.
</span><span class="kw">pub async fn </span>get_user_total_exam_points(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    exam_id: Uuid,
) -&gt; ModelResult&lt;f32&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query!</span>(
        <span class="string">r#&quot;
SELECT COALESCE(SUM(score_given), 0) AS &quot;points!&quot;
FROM user_exercise_states
WHERE user_id = $2
  AND exam_id = $1
  AND deleted_at IS NULL
        &quot;#</span>,
        exam_id,
        user_id,
    )
    .map(|x| x.points)
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">fn </span>merge_modules_with_metrics(
    course_modules: Vec&lt;CourseModule&gt;,
    course_metrics_by_course_module_id: <span class="kw-2">&amp;</span>HashMap&lt;Uuid, CourseInstanceExerciseMetrics&gt;,
    user_metrics_by_course_module_id: <span class="kw-2">&amp;</span>HashMap&lt;Uuid, UserCourseInstanceMetrics&gt;,
    default_course_module_name_placeholder: <span class="kw-2">&amp;</span>str,
) -&gt; ModelResult&lt;Vec&lt;UserCourseInstanceProgress&gt;&gt; {
    course_modules
        .into_iter()
        .map(|course_module| {
            <span class="kw">let </span>user_metrics = user_metrics_by_course_module_id.get(<span class="kw-2">&amp;</span>course_module.id);
            <span class="kw">let </span>course_metrics = course_metrics_by_course_module_id.get(<span class="kw-2">&amp;</span>course_module.id);
            <span class="kw">let </span>requirements = course_module.completion_policy.automatic();
            <span class="kw">let </span>progress = UserCourseInstanceProgress {
                course_module_id: course_module.id,
                <span class="comment">// Only default course module doesn&#39;t have a name.
                </span>course_module_name: course_module
                    .name
                    .unwrap_or_else(|| default_course_module_name_placeholder.to_string()),
                course_module_order_number: course_module.order_number,
                score_given: option_f32_to_f32_two_decimals_with_none_as_zero(
                    user_metrics.and_then(|x| x.score_given),
                ),
                score_required: requirements.and_then(|x| x.number_of_points_treshold),
                score_maximum: course_metrics
                    .and_then(|x| x.score_maximum)
                    .map(TryInto::try_into)
                    .transpose()<span class="question-mark">?</span>,
                total_exercises: course_metrics
                    .and_then(|x| x.total_exercises)
                    .map(TryInto::try_into)
                    .transpose()<span class="question-mark">?</span>,
                attempted_exercises: user_metrics
                    .and_then(|x| x.attempted_exercises)
                    .map(TryInto::try_into)
                    .transpose()<span class="question-mark">?</span>,
                attempted_exercises_required: requirements
                    .and_then(|x| x.number_of_exercises_attempted_treshold),
            };
            <span class="prelude-val">Ok</span>(progress)
        })
        .collect::&lt;ModelResult&lt;<span class="kw">_</span>&gt;&gt;()
}

<span class="kw">pub async fn </span>get_user_course_instance_chapter_exercises_progress(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
    exercise_ids: <span class="kw-2">&amp;</span>[Uuid],
    user_id: Uuid,
) -&gt; ModelResult&lt;Vec&lt;DatabaseUserCourseInstanceChapterExerciseProgress&gt;&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        DatabaseUserCourseInstanceChapterExerciseProgress,
        <span class="string">r#&quot;
SELECT COALESCE(ues.score_given, 0) AS score_given,
  ues.exercise_id AS exercise_id
FROM user_exercise_states AS ues
WHERE ues.deleted_at IS NULL
  AND ues.exercise_id IN (
    SELECT UNNEST($1::uuid [])
  )
  AND ues.course_instance_id = $2
  AND ues.user_id = $3;
        &quot;#</span>,
        exercise_ids,
        course_instance_id,
        user_id,
    )
    .fetch_all(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_or_create_user_exercise_state(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    exercise_id: Uuid,
    course_instance_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    exam_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>existing = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
SELECT id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
FROM user_exercise_states
WHERE user_id = $1
  AND exercise_id = $2
  AND (course_instance_id = $3 OR exam_id = $4)
  AND deleted_at IS NULL
&quot;#</span>,
        user_id,
        exercise_id,
        course_instance_id,
        exam_id
    )
    .fetch_optional(<span class="kw-2">&amp;mut *</span>conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">let </span>res = <span class="kw">if let </span><span class="prelude-val">Some</span>(existing) = existing {
        existing
    } <span class="kw">else </span>{
        <span class="macro">sqlx::query_as!</span>(
            UserExerciseState,
            <span class="string">r#&quot;
    INSERT INTO user_exercise_states (user_id, exercise_id, course_instance_id, exam_id)
    VALUES ($1, $2, $3, $4)
    RETURNING id,
      user_id,
      exercise_id,
      course_instance_id,
      exam_id,
      created_at,
      updated_at,
      deleted_at,
      score_given,
      grading_progress as &quot;grading_progress: _&quot;,
      activity_progress as &quot;activity_progress: _&quot;,
      reviewing_stage AS &quot;reviewing_stage: _&quot;,
      selected_exercise_slide_id
      &quot;#</span>,
            user_id,
            exercise_id,
            course_instance_id,
            exam_id
        )
        .fetch_one(<span class="kw-2">&amp;mut *</span>conn)
        .<span class="kw">await</span><span class="question-mark">?
    </span>};
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_by_id(conn: <span class="kw-2">&amp;mut </span>PgConnection, id: Uuid) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
SELECT id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
FROM user_exercise_states
WHERE id = $1
  AND deleted_at IS NULL
        &quot;#</span>,
        id,
    )
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>get_users_current_by_exercise(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    exercise: <span class="kw-2">&amp;</span>Exercise,
) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>course_or_exam_id = CourseOrExamId::from(exercise.course_id, exercise.exam_id)<span class="question-mark">?</span>;
    <span class="kw">let </span>course_instance_or_exam_id = <span class="kw">match </span>course_or_exam_id {
        CourseOrExamId::Course(course_id) =&gt; {
            user_course_settings::get_user_course_settings_by_course_id(conn, user_id, course_id)
                .<span class="kw">await</span><span class="question-mark">?
                </span>.map(|settings| {
                    CourseInstanceOrExamId::Instance(settings.current_course_instance_id)
                })
                .ok_or_else(|| {
                    ModelError::new(
                        ModelErrorType::PreconditionFailed,
                        <span class="string">&quot;Missing user course settings.&quot;</span>.to_string(),
                        <span class="prelude-val">None</span>,
                    )
                })
        }
        CourseOrExamId::Exam(exam_id) =&gt; <span class="prelude-val">Ok</span>(CourseInstanceOrExamId::Exam(exam_id)),
    }<span class="question-mark">?</span>;
    <span class="kw">let </span>user_exercise_state =
        get_user_exercise_state_if_exists(conn, user_id, exercise.id, course_instance_or_exam_id)
            .<span class="kw">await</span><span class="question-mark">?
            </span>.ok_or_else(|| {
                ModelError::new(
                    ModelErrorType::PreconditionFailed,
                    <span class="string">&quot;Missing user exercise state.&quot;</span>.to_string(),
                    <span class="prelude-val">None</span>,
                )
            })<span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(user_exercise_state)
}

<span class="kw">pub async fn </span>get_user_exercise_state_if_exists(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    exercise_id: Uuid,
    course_instance_or_exam_id: CourseInstanceOrExamId,
) -&gt; ModelResult&lt;<span class="prelude-ty">Option</span>&lt;UserExerciseState&gt;&gt; {
    <span class="kw">let </span>(course_instance_id, exam_id) = course_instance_or_exam_id.to_instance_and_exam_ids();
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
SELECT id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
FROM user_exercise_states
WHERE user_id = $1
  AND exercise_id = $2
  AND (course_instance_id = $3 OR exam_id = $4)
  AND deleted_at IS NULL
      &quot;#</span>,
        user_id,
        exercise_id,
        course_instance_id,
        exam_id
    )
    .fetch_optional(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>upsert_selected_exercise_slide_id(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    exercise_id: Uuid,
    course_instance_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    exam_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
    selected_exercise_slide_id: <span class="prelude-ty">Option</span>&lt;Uuid&gt;,
) -&gt; ModelResult&lt;()&gt; {
    <span class="kw">let </span>existing = <span class="macro">sqlx::query!</span>(
        <span class="string">&quot;
SELECT
FROM user_exercise_states
WHERE user_id = $1
  AND exercise_id = $2
  AND (course_instance_id = $3 OR exam_id = $4)
  AND deleted_at IS NULL
&quot;</span>,
        user_id,
        exercise_id,
        course_instance_id,
        exam_id
    )
    .fetch_optional(<span class="kw-2">&amp;mut *</span>conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="kw">if </span>existing.is_some() {
        <span class="macro">sqlx::query!</span>(
            <span class="string">&quot;
UPDATE user_exercise_states
SET selected_exercise_slide_id = $4
WHERE user_id = $1
  AND exercise_id = $2
  AND (course_instance_id = $3 OR exam_id = $5)
  AND deleted_at IS NULL
    &quot;</span>,
            user_id,
            exercise_id,
            course_instance_id,
            selected_exercise_slide_id,
            exam_id
        )
        .execute(<span class="kw-2">&amp;mut *</span>conn)
        .<span class="kw">await</span><span class="question-mark">?</span>;
    } <span class="kw">else </span>{
        <span class="macro">sqlx::query!</span>(
            <span class="string">&quot;
    INSERT INTO user_exercise_states (
        user_id,
        exercise_id,
        course_instance_id,
        selected_exercise_slide_id,
        exam_id
      )
    VALUES ($1, $2, $3, $4, $5)
    &quot;</span>,
            user_id,
            exercise_id,
            course_instance_id,
            selected_exercise_slide_id,
            exam_id
        )
        .execute(<span class="kw-2">&amp;mut *</span>conn)
        .<span class="kw">await</span><span class="question-mark">?</span>;
    }
    <span class="prelude-val">Ok</span>(())
}

<span class="doccomment">/// TODO: should be moved to the user_exercise_state_updater as a private module so that this cannot be called outside of that module
</span><span class="kw">pub async fn </span>update(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_exercise_state_update: UserExerciseStateUpdate,
) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
UPDATE user_exercise_states
SET score_given = $1,
  activity_progress = $2,
  reviewing_stage = $3,
  grading_progress = $4
WHERE id = $5
  AND deleted_at IS NULL
RETURNING id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
        &quot;#</span>,
        user_exercise_state_update.score_given,
        user_exercise_state_update.activity_progress <span class="kw">as </span>ActivityProgress,
        user_exercise_state_update.reviewing_stage <span class="kw">as </span>ReviewingStage,
        user_exercise_state_update.grading_progress <span class="kw">as </span>GradingProgress,
        user_exercise_state_update.id,
    )
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="kw">pub async fn </span>update_reviewing_stage(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    user_id: Uuid,
    course_instance_or_exam_id: CourseInstanceOrExamId,
    exercise_id: Uuid,
    new_reviewing_stage: ReviewingStage,
) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>(course_instance_id, exam_id) = course_instance_or_exam_id.to_instance_and_exam_ids();
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
UPDATE user_exercise_states
SET reviewing_stage = $5
WHERE user_id = $1
AND (course_instance_id = $2 OR exam_id = $3)
AND exercise_id = $4
RETURNING id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
        &quot;#</span>,
        user_id,
        course_instance_id,
        exam_id,
        exercise_id,
        new_reviewing_stage <span class="kw">as </span>ReviewingStage
    )
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="doccomment">/// TODO: should be removed
</span><span class="kw">pub async fn </span>update_exercise_progress(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    id: Uuid,
    reviewing_stage: ReviewingStage,
) -&gt; ModelResult&lt;UserExerciseState&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        UserExerciseState,
        <span class="string">r#&quot;
UPDATE user_exercise_states
SET reviewing_stage = $1
WHERE id = $2
  AND deleted_at IS NULL
RETURNING id,
  user_id,
  exercise_id,
  course_instance_id,
  exam_id,
  created_at,
  updated_at,
  deleted_at,
  score_given,
  grading_progress AS &quot;grading_progress: _&quot;,
  activity_progress AS &quot;activity_progress: _&quot;,
  reviewing_stage AS &quot;reviewing_stage: _&quot;,
  selected_exercise_slide_id
        &quot;#</span>,
        reviewing_stage <span class="kw">as </span>ReviewingStage,
        id
    )
    .fetch_one(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="doccomment">/// Convenience struct that combines user state to the exercise.
///
/// Many operations require information about both the user state and the exercise. However, because
/// exercises can either belong to a course or an exam, and each course instance will have their
/// own `UserExerciseState`, it can get difficult to track the proper context.
</span><span class="kw">pub struct </span>ExerciseWithUserState {
    exercise: Exercise,
    user_exercise_state: UserExerciseState,
    type_data: EwusCourseOrExam,
}

<span class="kw">impl </span>ExerciseWithUserState {
    <span class="kw">pub fn </span>new(exercise: Exercise, user_exercise_state: UserExerciseState) -&gt; ModelResult&lt;<span class="self">Self</span>&gt; {
        <span class="kw">let </span>state = EwusCourseOrExam::from_exercise_and_user_exercise_state(
            <span class="kw-2">&amp;</span>exercise,
            <span class="kw-2">&amp;</span>user_exercise_state,
        )<span class="question-mark">?</span>;
        <span class="prelude-val">Ok</span>(<span class="self">Self </span>{
            exercise,
            user_exercise_state,
            type_data: state,
        })
    }

    <span class="doccomment">/// Provides a reference to the inner `Exercise`.
    </span><span class="kw">pub fn </span>exercise(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>Exercise {
        <span class="kw-2">&amp;</span><span class="self">self</span>.exercise
    }

    <span class="doccomment">/// Provides a reference to the inner `UserExerciseState`.
    </span><span class="kw">pub fn </span>user_exercise_state(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>UserExerciseState {
        <span class="kw-2">&amp;</span><span class="self">self</span>.user_exercise_state
    }

    <span class="kw">pub fn </span>exercise_context(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="kw-2">&amp;</span>EwusCourseOrExam {
        <span class="kw-2">&amp;</span><span class="self">self</span>.type_data
    }

    <span class="kw">pub fn </span>set_user_exercise_state(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        user_exercise_state: UserExerciseState,
    ) -&gt; ModelResult&lt;()&gt; {
        <span class="self">self</span>.type_data = EwusCourseOrExam::from_exercise_and_user_exercise_state(
            <span class="kw-2">&amp;</span><span class="self">self</span>.exercise,
            <span class="kw-2">&amp;</span>user_exercise_state,
        )<span class="question-mark">?</span>;
        <span class="self">self</span>.user_exercise_state = user_exercise_state;
        <span class="prelude-val">Ok</span>(())
    }

    <span class="kw">pub fn </span>is_exam_exercise(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; bool {
        <span class="kw">match </span><span class="self">self</span>.type_data {
            EwusCourseOrExam::Course(<span class="kw">_</span>) =&gt; <span class="bool-val">false</span>,
            EwusCourseOrExam::Exam(<span class="kw">_</span>) =&gt; <span class="bool-val">true</span>,
        }
    }
}

<span class="kw">pub struct </span>EwusCourse {
    <span class="kw">pub </span>course_id: Uuid,
    <span class="kw">pub </span>course_instance_id: Uuid,
}

<span class="kw">pub struct </span>EwusExam {
    <span class="kw">pub </span>exam_id: Uuid,
}

<span class="kw">pub enum </span>EwusContext&lt;C, E&gt; {
    Course(C),
    Exam(E),
}

<span class="kw">pub enum </span>EwusCourseOrExam {
    Course(EwusCourse),
    Exam(EwusExam),
}

<span class="kw">impl </span>EwusCourseOrExam {
    <span class="kw">pub fn </span>from_exercise_and_user_exercise_state(
        exercise: <span class="kw-2">&amp;</span>Exercise,
        user_exercise_state: <span class="kw-2">&amp;</span>UserExerciseState,
    ) -&gt; ModelResult&lt;<span class="self">Self</span>&gt; {
        <span class="kw">if </span>exercise.id == user_exercise_state.exercise_id {
            <span class="kw">let </span>course_id = exercise.course_id;
            <span class="kw">let </span>course_instance_id = user_exercise_state.course_instance_id;
            <span class="kw">let </span>exam_id = exercise.exam_id;
            <span class="kw">match </span>(course_id, course_instance_id, exam_id) {
                (<span class="prelude-val">None</span>, <span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(exam_id)) =&gt; <span class="prelude-val">Ok</span>(<span class="self">Self</span>::Exam(EwusExam { exam_id })),
                (<span class="prelude-val">Some</span>(course_id), <span class="prelude-val">Some</span>(course_instance_id), <span class="prelude-val">None</span>) =&gt; <span class="prelude-val">Ok</span>(<span class="self">Self</span>::Course(EwusCourse {
                    course_id,
                    course_instance_id,
                })),
                <span class="kw">_ </span>=&gt; <span class="prelude-val">Err</span>(ModelError::new(
                    ModelErrorType::Generic,
                    <span class="string">&quot;Invalid initializer data.&quot;</span>.to_string(),
                    <span class="prelude-val">None</span>,
                )),
            }
        } <span class="kw">else </span>{
            <span class="prelude-val">Err</span>(ModelError::new(
                ModelErrorType::Generic,
                <span class="string">&quot;Exercise doesn&#39;t match the state.&quot;</span>.to_string(),
                <span class="prelude-val">None</span>,
            ))
        }
    }
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>CourseInstanceUserPoints {
    <span class="kw">pub </span>user_id: Uuid,
    <span class="kw">pub </span>points_for_each_chapter: Vec&lt;CourseInstanceUserPointsInner&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>CourseInstanceUserPointsInner {
    <span class="kw">pub </span>chapter_number: i32,
    <span class="kw">pub </span>points_for_chapter: f32,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>ExamUserPoints {
    <span class="kw">pub </span>user_id: Uuid,
    <span class="kw">pub </span>email: String,
    <span class="kw">pub </span>points_for_exercise: Vec&lt;ExamUserPointsInner&gt;,
}

<span class="attribute">#[derive(Debug, Serialize, Deserialize, PartialEq, Clone)]
</span><span class="kw">pub struct </span>ExamUserPointsInner {
    <span class="kw">pub </span>exercise_id: Uuid,
    <span class="kw">pub </span>score_given: f32,
}

<span class="kw">pub fn </span>stream_course_instance_points(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_instance_id: Uuid,
) -&gt; <span class="kw">impl </span>Stream&lt;Item = sqlx::Result&lt;CourseInstanceUserPoints&gt;&gt; + <span class="lifetime">&#39;_ </span>{
    <span class="macro">sqlx::query!</span>(
        <span class="string">&quot;
SELECT user_id,
  to_jsonb(array_agg(to_jsonb(uue) - &#39;email&#39; - &#39;user_id&#39;)) AS points_for_each_chapter
FROM (
    SELECT u.email,
      u.id AS user_id,
      c.chapter_number,
      COALESCE(SUM(ues.score_given), 0) AS points_for_chapter
    FROM user_exercise_states ues
      JOIN users u ON u.id = ues.user_id
      JOIN exercises e ON e.id = ues.exercise_id
      JOIN chapters c on e.chapter_id = c.id
    WHERE ues.course_instance_id = $1
      AND ues.deleted_at IS NULL
      AND c.deleted_at IS NULL
      AND u.deleted_at IS NULL
      AND e.deleted_at IS NULL
    GROUP BY u.email,
      u.id,
      c.chapter_number
  ) as uue
GROUP BY user_id

&quot;</span>,
        course_instance_id
    )
    .try_map(|i| {
        <span class="kw">let </span>user_id = i.user_id;
        <span class="kw">let </span>points_for_each_chapter = i.points_for_each_chapter.unwrap_or(Value::Null);
        serde_json::from_value(points_for_each_chapter)
            .map(|points_for_each_chapter| CourseInstanceUserPoints {
                user_id,
                points_for_each_chapter,
            })
            .map_err(|e| sqlx::Error::Decode(Box::new(e)))
    })
    .fetch(conn)
}

<span class="kw">pub fn </span>stream_exam_points(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    exam_id: Uuid,
) -&gt; <span class="kw">impl </span>Stream&lt;Item = sqlx::Result&lt;ExamUserPoints&gt;&gt; + <span class="lifetime">&#39;_ </span>{
    <span class="macro">sqlx::query!</span>(
        <span class="string">&quot;
SELECT user_id,
  email,
  to_jsonb(array_agg(to_jsonb(uue) - &#39;email&#39; - &#39;user_id&#39;)) AS points_for_exercises
FROM (
    SELECT u.id AS user_id,
      u.email,
      exercise_id,
      COALESCE(score_given, 0) as score_given
    FROM user_exercise_states ues
      JOIN users u ON u.id = ues.user_id
      JOIN exercises e ON e.id = ues.exercise_id
    WHERE ues.exam_id = $1
      AND ues.deleted_at IS NULL
      AND u.deleted_at IS NULL
      AND e.deleted_at IS NULL
  ) as uue
GROUP BY user_id,
  email
&quot;</span>,
        exam_id
    )
    .try_map(|i| {
        <span class="kw">let </span>user_id = i.user_id;
        <span class="kw">let </span>points_for_exercises = i.points_for_exercises.unwrap_or(Value::Null);
        serde_json::from_value(points_for_exercises)
            .map(|points_for_exercise| ExamUserPoints {
                user_id,
                points_for_exercise,
                email: i.email,
            })
            .map_err(|e| sqlx::Error::Decode(Box::new(e)))
    })
    .fetch(conn)
}

<span class="kw">pub async fn </span>get_course_users_counts_by_exercise(
    conn: <span class="kw-2">&amp;mut </span>PgConnection,
    course_id: Uuid,
) -&gt; ModelResult&lt;Vec&lt;ExerciseUserCounts&gt;&gt; {
    <span class="kw">let </span>res = <span class="macro">sqlx::query_as!</span>(
        ExerciseUserCounts,
        <span class="string">r#&quot;
SELECT exercises.name as exercise_name,
  exercises.order_number as exercise_order_number,
  pages.order_number as page_order_number,
  chapters.chapter_number,
  stat_data.*
FROM (
    SELECT exercise_id,
      COUNT(DISTINCT user_id) FILTER (
        WHERE ues.activity_progress = &#39;completed&#39;
      ) as n_users_attempted,
      COUNT(DISTINCT user_id) FILTER (
        WHERE ues.score_given IS NOT NULL
          and ues.score_given &gt; 0
          AND ues.activity_progress = &#39;completed&#39;
      ) as n_users_with_some_points,
      COUNT(DISTINCT user_id) FILTER (
        WHERE ues.score_given IS NOT NULL
          and ues.score_given &gt;= exercises.score_maximum
          and ues.activity_progress = &#39;completed&#39;
      ) as n_users_with_max_points
    FROM exercises
      JOIN user_exercise_states ues on exercises.id = ues.exercise_id
    WHERE exercises.course_id = $1
      AND exercises.deleted_at IS NULL
      AND ues.deleted_at IS NULL
    GROUP BY exercise_id
  ) as stat_data
  JOIN exercises ON stat_data.exercise_id = exercises.id
  JOIN pages on exercises.page_id = pages.id
  JOIN chapters on pages.chapter_id = chapters.id
WHERE exercises.deleted_at IS NULL
  AND pages.deleted_at IS NULL
  AND chapters.deleted_at IS NULL
          &quot;#</span>,
        course_id
    )
    .fetch_all(conn)
    .<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(res)
}

<span class="attribute">#[cfg(test)]
</span><span class="kw">mod </span>tests {
    <span class="kw">use </span>chrono::TimeZone;

    <span class="kw">use super</span>::<span class="kw-2">*</span>;
    <span class="kw">use </span><span class="kw">crate</span>::test_helper::<span class="kw-2">*</span>;

    <span class="kw">mod </span>getting_single_module_course_instance_metrics {
        <span class="kw">use super</span>::<span class="kw-2">*</span>;

        <span class="attribute">#[tokio::test]
        </span><span class="kw">async fn </span>works_without_any_user_exercise_states() {
            <span class="macro">insert_data!</span>(:tx, :user, :org, :course, :instance, :course_module);
            <span class="kw">let </span>res = get_single_module_course_instance_metrics(
                tx.as_mut(),
                instance.id,
                course_module.id,
                user,
            )
            .<span class="kw">await</span>;
            <span class="macro">assert!</span>(res.is_ok())
        }
    }

    <span class="attribute">#[test]
    </span><span class="kw">fn </span>merges_course_modules_with_metrics() {
        <span class="kw">let </span>timestamp = Utc.with_ymd_and_hms(<span class="number">2022</span>, <span class="number">6</span>, <span class="number">22</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>).unwrap();
        <span class="kw">let </span>module_id = Uuid::parse_str(<span class="string">&quot;9e831ecc-9751-42f1-ae7e-9b2f06e523e8&quot;</span>).unwrap();
        <span class="kw">let </span>course_modules = <span class="macro">vec!</span>[CourseModule::new(
            module_id,
            Uuid::parse_str(<span class="string">&quot;3fa4bee6-7390-415e-968f-ecdc5f28330e&quot;</span>).unwrap(),
        )
        .set_timestamps(timestamp, timestamp, <span class="prelude-val">None</span>)
        .set_registration_info(<span class="prelude-val">None</span>, <span class="prelude-val">Some</span>(<span class="number">5</span>), <span class="prelude-val">None</span>)];
        <span class="kw">let </span>course_metrics_by_course_module_id = HashMap::from([(
            module_id,
            CourseInstanceExerciseMetrics {
                course_module_id: module_id,
                total_exercises: <span class="prelude-val">Some</span>(<span class="number">4</span>),
                score_maximum: <span class="prelude-val">Some</span>(<span class="number">10</span>),
            },
        )]);
        <span class="kw">let </span>user_metrics_by_course_module_id = HashMap::from([(
            module_id,
            UserCourseInstanceMetrics {
                course_module_id: module_id,
                score_given: <span class="prelude-val">Some</span>(<span class="number">1.0</span>),
                attempted_exercises: <span class="prelude-val">Some</span>(<span class="number">3</span>),
            },
        )]);
        <span class="kw">let </span>metrics = merge_modules_with_metrics(
            course_modules,
            <span class="kw-2">&amp;</span>course_metrics_by_course_module_id,
            <span class="kw-2">&amp;</span>user_metrics_by_course_module_id,
            <span class="string">&quot;Default module&quot;</span>,
        )
        .unwrap();
        <span class="macro">assert_eq!</span>(metrics.len(), <span class="number">1</span>);
        <span class="kw">let </span>metric = metrics.first().unwrap();
        <span class="macro">assert_eq!</span>(metric.attempted_exercises, <span class="prelude-val">Some</span>(<span class="number">3</span>));
        <span class="macro">assert_eq!</span>(<span class="kw-2">&amp;</span>metric.course_module_name, <span class="string">&quot;Default module&quot;</span>);
        <span class="macro">assert_eq!</span>(metric.score_given, <span class="number">1.0</span>);
        <span class="macro">assert_eq!</span>(metric.score_maximum, <span class="prelude-val">Some</span>(<span class="number">10</span>));
        <span class="macro">assert_eq!</span>(metric.total_exercises, <span class="prelude-val">Some</span>(<span class="number">4</span>));
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="headless_lms_models" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.1 (90743e729 2023-01-10)" ></div></body></html>